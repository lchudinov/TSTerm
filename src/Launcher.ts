/*
  This program and the accompanying materials are
  made available under the terms of the Eclipse Public License v2.0 which accompanies
  this distribution, and is available at https://www.eclipse.org/legal/epl-v20.html
  
  SPDX-License-Identifier: EPL-2.0
  
  Copyright Contributors to the Zowe Project.
  Copyright Contributors to the Open Mainframe Project's TSTerm Project
*/

import { Utils } from "./Utils";
import { ScreenElement } from "./Paged";
import { VirtualScreen3270, DeviceType3270, TN3270EParser } from "./Model3270";

export class TerminalLauncher{
    constructor(){

    }

    static renderTest(screenParms:any){
	let width = 80;
	let height = 24;
	var screen = new VirtualScreen3270(width, height);
	screen.Oi(screenParms.parentDiv, screenParms);
	screen.initScreen();
	let r;
	let c;
	for (r=1; r<4; r++){
	    for (c=0; c<0x40; c++){
		let screenPos = r*width+c;
		let ebcdicChar = (r*0x40)+c;
		screen.putScreenElement(screenPos,new ScreenElement(screenPos,ebcdicChar,null));
	    }
	}
	console.log("renderTest(): before showScreen()");
	screen.showScreen();
	console.log("renderTest(): after showScreen()");
    }

    /* remember when using packet captures to test parsing to strip out telnet escape sequences and 
       trailers, etc */
    static wsfBytes2:number[] =
	[ 0x00, 0x05, 0x9a, 0x3c, 0x7a, 0x00, 0x00, 0x11, 0x22, 0x33, 0x44, 0x55, 0x08, 0x00, 0x45, 0x00,
	  0x00, 0xa7, 0x27, 0x25, 0x00, 0x00, 0x3f, 0x06, 0x20, 0x3f, 0xac, 0x1d, 0x7a, 0xa4, 0xac, 0x1d,
	  0x61, 0x0e, 0x02, 0x6f, 0xdd, 0xb1, 0x39, 0xc3, 0x71, 0x5f, 0xc2, 0x05, 0x7b, 0x2d, 0x50, 0x18,
	  0x0f, 0xff, 0x87, 0x11, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 0x30, 0xf3, 0x00, 0x08, 0x0f, 0x02,
	  0x00, 0x00, 0x81, 0x01, 0x00, 0x0f, 0x10, 0x13, 0x00, 0x00, 0x1f, 0x08, 0x01, 0x18, 0x00, 0x73,
	  0x02, 0x00, 0x00, 0x00, 0x07, 0x06, 0x01, 0xff, /* 0xff, */ 0x41, 0x02, 0x00, 0x07, 0x06, 0x01, 0xff,
	  /* 0xff, */ 0x41, 0x03, 0x00, 0x23, 0x0f, 0x11, 0x00, 0xc0, 0x00, 0x30, 0x0a, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x21, 0x06, 0x03, 0x18, 0x00, 0x8f, 0x02, 0xee, 0x21, 0x06,
	  0x00, 0x30, 0x00, 0x8f, 0x02, 0x05, 0x00, 0x2d, 0x0f, 0x10, 0x00, 0xc0, 0x00, 0x70, 0x0c, 0x00,
	  0x00, 0x00, 0x00, 0x54, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0xc1, 0x04, 0x00, 0x00, 0x00,
	  0x00, 0x81, 0x04, 0x00, 0x8f, 0x00, 0x00, 0x81, 0x04, 0x00, 0x8f, 0x00, 0x4c, 0x81, 0x04, 0x00,
	  0x00, 0x00, 0x00]; /* , 0xff, 0xef]; */

    static wsfBytes:number[] =
	[ 0x00, 0x05, 0x9a, 0x3c, 0x7a, 0x00, 0x00, 0x11, 0x22, 0x33, 0x44, 0x55, 0x08, 0x00, 0x45, 0x00,
	  0x00, 0xfd, 0x43, 0xce, 0x00, 0x00, 0x3f, 0x06, 0x02, 0xee, 0xac, 0x1d, 0x7a, 0xa4, 0xac, 0x1d,
	  0x61, 0x60, 0x02, 0x6f, 0xfa, 0x51, 0x0a, 0x0a, 0xa8, 0x5c, 0x52, 0x8a, 0x92, 0x33, 0x50, 0x18,
	  0x0f, 0xff, 0xc1, 0xec, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 0x31, 0xf3, 0x00, 0x04, 0x03, 0x80,
	  0x00, 0x1e, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c,
	  0x00, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x09, 0x00, 0x0d, 0x00, 0x31,
	  0x0f, 0x11, 0x00, 0xc0, 0x00, 0x30, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x00,
	  0x00, 0x21, 0x06, 0x03, 0x18, 0x00, 0x8f, 0x02, 0xee, 0x21, 0x06, 0x00, 0x30, 0x00, 0x8f, 0x02,
	  0x05, 0x21, 0x0c, 0x05, 0xf0, 0x00, 0x8f, 0xfd, 0xab, 0x02, 0x54, 0xfe, 0x7a, 0x01, 0x85, 0x00,
	  0x2d, 0x0f, 0x10, 0x00, 0xc0, 0x00, 0x70, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x54, 0x00, 0x00, 0x18,
	  0x00, 0x00, 0x00, 0x00, 0xc1, 0x04, 0x00, 0x00, 0x00, 0x00, 0x81, 0x04, 0x00, 0xec, 0x00, 0x00,
	  0x81, 0x04, 0x00, 0xec, 0x00, 0x9b, 0x81, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1b, 0x0f, 0x11,
	  0x00, 0xc0, 0x00, 0x30, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x21,
	  0x06, 0x03, 0x18, 0x00, 0x8f, 0x00, 0xee, 0x00, 0x31, 0x40, 0x00, 0xf1, 0xf3, 0x11, 0x01, 0x58,
	  0x1d, 0xf0, 0x11, 0x01, 0x07, 0x29, 0x02, 0xc0, 0x40, 0x46, 0xff, /* 0xff, */ 0xd9, 0xc9, 0xc7, 0xc8,
	  0xe3, 0x60, 0xc1, 0xd5, 0xc7, 0xd3, 0xc5, 0xc4, 0x40, 0xe3, 0xd9, 0xc9, 0xc1, 0xd5, 0xc7, 0xd3,
	  0xc5, 0x3c, 0x01, 0x58, 0x00, 0x11, 0x00, 0x00, 0x13];

    
    static parseTest(screenParms:any):void{
	let width = 80;
	let height = 24;
	console.log("Starting parse WSF test...");
	var screen = new VirtualScreen3270(width, height);
	let parser = new TN3270EParser(screen, "3270_CLIENT_MESSAGE");
	screen.parser = parser;
	screen.deviceType = DeviceType3270.ps
	screen.alternateWidth = 132;
	screen.alternateHeight = 60;
	screen.inTN3270EMode = true;
	let wsfBytes = TerminalLauncher.wsfBytes;
	let order = parser.parseWSF(wsfBytes,0x3B,wsfBytes.length,true);
	console.log("WSF order = "+JSON.stringify(order));
	
    }

    static start3270 = function (screenParms:any, // { parentDiv: width: w height: h } html params was t
				 cnxnSettings:any, // n, includes charsetName
				 i:any,  // has contextRightClick and keyboardMappings
				 callbacks:any, // a js object with k-v paairs
				 additionalScreenProperties:any):VirtualScreen3270 {   // "e" clone-copy from this if supplied
	var securityType = 0;
	var u = 0; // dunno 
	var screen = new VirtualScreen3270(80, 24); // formerly h
	if (additionalScreenProperties){
	    screen = Object.assign(screen, additionalScreenProperties);
	}
	screen.Oi(screenParms.parentDiv, screenParms); // sets up drawing stuff
	screen.callbacks = callbacks;
	screen.Ne();  // sets up callbacs
        screen.na = cnxnSettings;
	// Joe doesn't like the follwing minification
        // (h.enableTN3270E = void 0 === cnxnSettings.enableTN3270E || cnxnSettings.enableTN3270E),
	screen.enableTN3270E = cnxnSettings.enableTN3270E;
	if (null != i){
	    screen.zn = i;
	    screen.keyboardMap = i.keyboardMappingVS;
	    screen.contextRightClick = i.contextRightClick;
	}
	if ((cnxnSettings.charsetName &&
	     ("string" == typeof cnxnSettings.charsetName))){
	    screen.setCharsetInfo(cnxnSettings.charsetName);
	}
	if (cnxnSettings.deviceType && "number" == typeof cnxnSettings.deviceType){
            switch (cnxnSettings.deviceType) {
            case 1:
                screen.deviceType = DeviceType3270.deviceType1E;
                break;
            case 2:
                screen.deviceType = DeviceType3270.deviceType2E;
                break;
            case 3:
                screen.deviceType = DeviceType3270.deviceType3E;
                break;
            case 4:
                screen.deviceType = DeviceType3270.deviceType4E;
                break;
            case 5:
                screen.deviceType = DeviceType3270.ps;
            }
            if (screen.deviceType === DeviceType3270.ps){
		if (cnxnSettings.alternateWidth &&
		    (typeof cnxnSettings.alternateWidth == "number")){
		    screen.alternateWidth = cnxnSettings.alternateWidth;
		}
		if (cnxnSettings.alternateHeight &&
		    (typeof cnxnSettings.alternateHeight == "number")){
		    screen.alternateHeight = cnxnSettings.alternateHeight;
		}
	    } // should we pop out anoher level
	    if (cnxnSettings.sessionDeviceName &&
		(typeof cnxnSettings.sessionDeviceName == "string")){
		screen.sessionDeviceName = cnxnSettings.sessionDeviceName;
	    }
	    if (cnxnSettings.oiaEnabled &&
		(typeof cnxnSettings.oidEnabled == "boolean")){
                screen.oiaEnabled = cnxnSettings.oiaEnabled ? 1 : 0;
	    }
	    if (cnxnSettings.security &&
		(typeof cnxnSettings.security == "object")){
		let securityParms = cnxnSettings.security;
		if (securityParms.type && ("number" == typeof securityParms.type)){
		    securityType = securityParms.type;
		}
		if (securityParms.badCert && ("number" == typeof securityParms.badCert)){
		    u = securityParms.badCert;
		}
	    }
        }
	// undeclared use of bi
	screen.bi = { host: cnxnSettings.host, port: Number(cnxnSettings.port),
		      security: securityType, la: u };
        screen.initScreen();
        Utils.coreLogger.debug("connect = " + cnxnSettings.connect);
        if (cnxnSettings.connect){
	    screen.connect(cnxnSettings.url, screen.bi);
	} else {
	    screen.scriptIsRunning = true;
	}
        screen.buildEventHandlers();
	if (screen.canvas){ // JOE - will be non-null
            screen.canvas.focus();
	}
        if (screen.callbacks && ("function" == typeof screen.callbacks.onInit)){
	    screen.callbacks.onInit();
	}
	return screen;
    }
    
}
